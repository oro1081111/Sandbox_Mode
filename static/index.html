<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ê≤ôÁõíËß£È°åÁ≥ªÁµ±</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #fff;
      margin: 0;
      padding: 20px;
    }
    .hex-container {
      position: relative;
      width: 300px;
      height: 340px;
      margin: 0 auto 20px;
    }
    .hex {
      width: 90px;
      height: 92px;
      background-color: #eee;
      position: absolute;
      clip-path: polygon(50% 0%, 93% 25%, 93% 75%, 50% 100%, 7% 75%, 7% 25%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 0;
    }
    .hex[data-pos="-1,1"] { top: 0px; left: 70px; }
    .hex[data-pos="0,1"] { top: 0px; left: 150px; }
    .hex[data-pos="-1,0"] { top: 72px; left: 30px; }
    .hex[data-pos="0,0"] { top: 72px; left: 110px; }
    .hex[data-pos="1,0"] { top: 72px; left: 190px; }
    .hex[data-pos="0,-1"] { top: 144px; left: 70px; }
    .hex[data-pos="1,-1"] { top: 144px; left: 150px; }

    .palette {
      display: grid;
      grid-template-columns: repeat(3, auto);
      grid-template-rows: repeat(2, auto);
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      position: relative;
    }

    .tile {
      width: 90px;
      height: 92px;
      background-color: gray;
      clip-path: polygon(50% 0%, 93% 25%, 93% 75%, 50% 100%, 7% 75%, 7% 25%);
      cursor: grab;
      display: inline-block;
      z-index: 1;
    }

    .R { background-color: #e57373; }
    .B { background-color: #64b5f6; }
    .G { background-color: #81c784; }
    .Y { background-color: #fdd835; }
    .P { background-color: #ba68c8; }

    .start-dot {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: black;
      cursor: grab;
      position: absolute;
      z-index: 1000;
    }

    button {
      font-size: 18px;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      background-color: #ddd;
      cursor: pointer;
    }

    #solution-box {
      margin-top: 20px;
      font-size: 18px;
      background: #f3f3f3;
      padding: 10px;
      border-radius: 8px;
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
      white-space: pre-line;
    }

    #solve-btn {
      position: relative;
      top: -50px;
    }

    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #555;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

  </style>
</head>
<body>
  <div class="hex-container" id="grid">
    <div class="hex" data-pos="-1,1"></div>
    <div class="hex" data-pos="0,1"></div>
    <div class="hex" data-pos="-1,0"></div>
    <div class="hex" data-pos="0,0"></div>
    <div class="hex" data-pos="1,0"></div>
    <div class="hex" data-pos="0,-1"></div>
    <div class="hex" data-pos="1,-1"></div>
  </div>

  <div class="palette" id="palette">
    <div class="tile R" draggable="true" data-color="R"></div>
    <div class="tile B" draggable="true" data-color="B"></div>
    <div class="tile Y" draggable="true" data-color="Y"></div>
    <div class="tile G" draggable="true" data-color="G"></div>
    <div class="tile P" draggable="true" data-color="P"></div>
  </div>

  <div class="start-dot" id="start-dot" draggable="true"></div>

 <button id="solve-btn" onclick="solve()">ÈñãÂßãËß£Á≠î</button>

  <div id="solution-box"></div>

  <script>
    const grid = document.getElementById('grid');
    const tiles = document.querySelectorAll('.tile');
    const hexes = document.querySelectorAll('.hex');
    const startDot = document.getElementById('start-dot');
    const solutionBox = document.getElementById('solution-box');
    const solveBtn = document.getElementById('solve-btn');
    let draggedElement = null;
    let startAssigned = null;

    window.addEventListener('DOMContentLoaded', () => {
      const positionMap = {
        'B': '-1,0',
        'R': '1,-1',
        'G': '-1,1',
        'Y': '0,0',
        'P': '1,0'
      };

      tiles.forEach(tile => {
        const color = tile.dataset.color;
        const pos = positionMap[color];
        const hex = document.querySelector(`.hex[data-pos="${pos}"]`);
        if (hex) {
          hex.appendChild(tile);
          hex.dataset.color = color;
        }

        enableTouchDrag(tile);  // ‚úÖ Êñ∞Â¢ûÔºöËÆì tile ÊîØÊè¥Ëß∏ÊéßÊãñÊõ≥
      });

      enableTouchDrag(startDot);  // ‚úÖ Êñ∞Â¢ûÔºöËÆìËµ∑ÂßãÈªû‰πüÊîØÊè¥Ëß∏ÊéßÊãñÊõ≥

      const hexWithStart = document.querySelector('.hex[data-pos="0,0"]');
      if (hexWithStart) {
        hexWithStart.appendChild(startDot);
        startDot.style.position = 'absolute';
        startDot.style.left = '25px';
        startDot.style.top = '28px';
        startAssigned = hexWithStart;
      }

      checkStartDotValidity();
    });


    let offsetX = 0, offsetY = 0;

    function enableTouchDrag(element) {
      element.addEventListener('touchstart', function (e) {
        draggedElement = element;
        const touch = e.touches[0];
        offsetX = touch.clientX - element.getBoundingClientRect().left;
        offsetY = touch.clientY - element.getBoundingClientRect().top;
        element.style.position = 'fixed';
        element.style.zIndex = 999;
      });

      element.addEventListener('touchmove', function (e) {
        if (!draggedElement) return;
        const touch = e.touches[0];
        draggedElement.style.left = `${touch.clientX - offsetX}px`;
        draggedElement.style.top = `${touch.clientY - offsetY}px`;
        e.preventDefault();
      });

      element.addEventListener('touchend', function (e) {
        const touch = e.changedTouches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);

        if (target && target.classList.contains('hex')) {
          const hex = target;

          if (draggedElement.classList.contains('start-dot')) {
            // ‚úÖ Ëµ∑ÂßãÈªû‰πüÂèØ‰ª•ÊîæÂà∞Â∑≤Êúâ tile ÁöÑ hex ‰∏ä
            hex.appendChild(draggedElement);
            draggedElement.style.position = 'absolute';
            draggedElement.style.left = '25px';
            draggedElement.style.top = '28px';
            startAssigned = hex;
          } else if (draggedElement.classList.contains('tile')) {
            const existingTile = hex.querySelector('.tile');
            const sourceParent = draggedElement.parentElement;

            if (existingTile && existingTile !== draggedElement) {
              const palette = document.getElementById('palette');
              const color = existingTile.dataset.color;

              // üîÅ Ëã• palette Ë£°Ê≤íÊúâÈÄôÈ°èËâ≤ÔºåÂ∞±ÊîæÂõû palette
              const alreadyInPalette = palette.querySelector(`.tile[data-color="${color}"]`);
              if (!alreadyInPalette) {
                palette.appendChild(existingTile);
              }

              // ‚úÖ Â∞áÊãñÊõ≥‰∏≠ÁöÑ tile ÊîæÈÄ≤ hex
              hex.replaceChild(draggedElement, existingTile);
            } else if (!existingTile) {
              hex.appendChild(draggedElement);
            }


            hex.dataset.color = draggedElement.dataset.color;
          }

          checkStartDotValidity();
        }

        // ‚úÖ ÊãñÊõ≥ÁµêÊùüÔºåÈáçË®≠Ê®£Âºè
        draggedElement.style.position = '';
        draggedElement.style.left = '';
        draggedElement.style.top = '';
        draggedElement.style.zIndex = '';
        draggedElement = null;
      });

    }



    tiles.forEach(tile => {
      tile.addEventListener('dragstart', () => {
        draggedElement = tile;
      });
    });

    startDot.addEventListener('dragstart', () => {
      draggedElement = startDot;
    });

    hexes.forEach(hex => {
      hex.addEventListener('dragover', e => e.preventDefault());

      hex.addEventListener('drop', e => {
        if (!draggedElement) return;

        if (draggedElement.classList.contains('start-dot')) {
          hex.appendChild(startDot);
          startDot.style.position = 'absolute';
          startDot.style.left = '25px';
          startDot.style.top = '28px';
          startAssigned = hex;
        } else if (draggedElement.classList.contains('tile')) {
          const existingTile = hex.querySelector('.tile');
          const sourceParent = draggedElement.parentElement;

          if (existingTile && existingTile !== draggedElement) {
            hex.replaceChild(draggedElement, existingTile);
            sourceParent.appendChild(existingTile);
          } else if (!existingTile) {
            hex.appendChild(draggedElement);
          }
          hex.dataset.color = draggedElement.dataset.color;
        }

        checkStartDotValidity();
      });
    });

    function checkStartDotValidity() {
    if (!startAssigned || !startAssigned.querySelector('.tile')) {
      solutionBox.innerText = 'Ëµ∑Âßã‰ΩçÁΩÆË®≠ÁΩÆÈåØË™§';
      solveBtn.disabled = true;
      solveBtn.style.backgroundColor = '#aaa';  // ÁÅ∞ÊéâÊåâÈàï
    } else {
      solutionBox.innerText = '';
      solveBtn.disabled = false;
      solveBtn.style.backgroundColor = '#ddd';  // ÈÇÑÂéüÊåâÈàïËâ≤
    }
  }


    async function solve() {
  // Ëã•ÈªëÈªûÊú™ÊîæÁΩÆÊñº‰ªª‰Ωï hexÔºåÊàñË©≤ hex Ê≤íÊúâÈ°èËâ≤ÊùøÂ°ä
  if (!startAssigned || !startAssigned.dataset.color) {
      solutionBox.innerText = 'Ëµ∑Âßã‰ΩçÁΩÆË®≠ÁΩÆÈåØË™§';
      return;
    }

    // Âª∫Á´ãÈ°èËâ≤Â∞çÊáâ‰ΩçÁΩÆÁöÑÁ¥¢Âºï
    const indexDict = {};
    let boyIndex = "";

    hexes.forEach(hex => {
      const colorTile = hex.querySelector('.tile');
      if (colorTile) {
        const color = colorTile.dataset.color;
        const pos = hex.dataset.pos;
        indexDict[color] = pos;
      }

      if (hex.contains(startDot)) {
        const colorTile = hex.querySelector('.tile');
        if (colorTile) {
          boyIndex = colorTile.dataset.color;  // ‚úÖ Áõ¥Êé•ÂèñÂæóÈ°èËâ≤
        }
      }
    });

    // ÂëºÂè´ FastAPI ÂæåÁ´Ø API
    solutionBox.innerHTML = `
      <div class="spinner"></div>
      <div>Ê≠£Âú®Â∞ãÊâæÊúÄ‰Ω≥Ëß£ÔºåË´ãÁ®çÂÄô...</div>
    `;
    try {
      const response = await fetch("https://sandbox-mode.onrender.com/solve", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          index_dict: indexDict,
          boy_index: boyIndex
        })
      });

      const data = await response.json();

    if (data.error) {
      solutionBox.innerText = `‚ùå ${data.error}`;
    } else {
      const formatted = data.solution.replaceAll('\n', '<br>');
      solutionBox.innerHTML =
        `ÊúÄ‰Ω≥Ê≠•Êï∏Ôºö${data.optimal_steps} Ê≠•<br>Ëß£Á≠îÔºö<br>${formatted}`;
    }


    } catch (err) {
      solutionBox.innerText = `‚ùå ÁôºÁîüÈåØË™§Ôºö${err.message}`;
    }
  }

  </script>
</body>
</html>
